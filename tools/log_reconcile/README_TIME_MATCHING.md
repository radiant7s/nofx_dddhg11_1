# 校准时间匹配说明

## 问题背景

在对账过程中发现有些订单和日志对不上，经过排查发现是时间匹配基准的问题。

## 决策日志中的时间字段

一个典型的决策日志 JSON 文件包含以下时间信息：

```json
{
  "timestamp": "2025-11-12T23:01:16.855133136+08:00",  // ❌ AI决策生成时间
  "input_prompt": "时间: 2025-11-12 23:00:50 ...",    // 市场数据采集时间
  "decisions": [
    {
      "action": "open_long",
      "timestamp": "2025-11-12T22:49:17.087+08:00",    // ✅ 实际订单成交时间
      "order_id": 1068746244
    }
  ]
}
```

## 时间字段解析

| 字段 | 含义 | 用途 |
|------|------|------|
| **顶层 `timestamp`** | AI生成决策的时间 | 记录决策周期，**不应用于匹配订单** |
| **`input_prompt` 时间** | 市场数据采集时间 | 显示给AI的市场快照时间 |
| **`decisions[].timestamp`** | **实际订单成交时间** | **这是币安返回的真实成交时间，应该用它来匹配** |

## 修复方案

### 之前的问题
代码可能混用了顶层 `timestamp`（AI决策时间）来匹配币安订单，导致时间差异过大。

### 现在的解决方案
✅ **统一使用 `decisions[].timestamp`（实际成交时间）来匹配币安订单**

```go
// 正确做法：使用 decisions 中的实际成交时间
if math.Abs(float64(o.Time-act.Timestamp.UnixMilli())) > 30*60*1000 {
    continue
}
```

### 时间容差
- **当前设置**: ±30分钟
- **原因**: 
  - 网络延迟
  - 订单排队等待成交
  - 限价单可能需要时间才能成交
  - 系统记录时间的微小差异

## 调试功能

当找不到匹配订单时，现在会输出详细的调试信息：

```
⏰ [调试] GIGGLEUSDT open_long 时间对比:
   决策记录时间: 2025-11-12 22:49:17
   订单 1 (ID:1068746244): 2025-11-12 22:49:17 (时间差 0.0分钟, 方向:BUY, 状态:FILLED)
   订单 2 (ID:1068746999): 2025-11-12 22:52:30 (时间差 3.2分钟, 方向:BUY, 状态:FILLED)
```

这样可以清楚地看到：
- 决策记录的时间
- 每个候选订单的实际时间
- 时间差异（分钟）
- 订单方向和状态

## 如何验证修复

1. **重新运行对账**:
   ```powershell
   go run .\tools\log_reconcile\*.go -action reconcile
   ```

2. **检查输出**:
   - 看是否还有 "未找到匹配的开仓订单" 的报告
   - 查看调试信息中的时间差异是否合理
   - 确认匹配的订单ID是否正确

3. **对比修复前后**:
   - 修复前：可能有大量时间差超过30分钟的不匹配
   - 修复后：大部分订单应该能找到匹配（时间差在几秒到几分钟内）

## 时间差异分析

### 正常情况
- **0-5秒**: 市价单立即成交 ✅
- **5秒-2分钟**: 网络延迟 + 币安处理时间 ✅
- **2-10分钟**: 限价单等待成交 ✅
- **10-30分钟**: 特殊市场条件（流动性不足、大幅波动）⚠️

### 异常情况
- **超过30分钟**: 可能是订单被取消重下、系统故障或匹配逻辑错误 ❌

## 相关文件

- `reconcile.go`: 主要对账逻辑（开仓/平仓匹配）
- `partial_close_reconcile.go`: 部分平仓对账逻辑
- 两个文件都已统一使用 `decisions[].timestamp`

## 版本历史

- **2025-11-13**: 修复时间匹配基准，统一使用 `decisions[].timestamp`，添加调试信息输出
